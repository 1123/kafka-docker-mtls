FROM confluentinc/cp-server:6.2.0 

# Broker uses TLSv1.2 by-default for ZooKeeper TLS connections
# See note for ZOOKEEPER_SSL_ENABLED_PROTOCOLS regarding TLS 1.3 support
# Uncomment the following property to evaluate TLS 1.3 for Broker<->ZooKeeper
#KAFKA_ZOOKEEPER_SSL_PROTOCOL=TLSv1.3

ENV KAFKA_ZOOKEEPER_CONNECT=zookeeper:2182 \
    KAFKA_ZOOKEEPER_SSL_CLIENT_ENABLE='true' \
    KAFKA_ZOOKEEPER_SSL_CIPHER_SUITES=TLS_AES_256_GCM_SHA384,TLS_CHACHA20_POLY1305_SHA256,TLS_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 \
    KAFKA_ZOOKEEPER_CLIENT_CNXN_SOCKET=org.apache.zookeeper.ClientCnxnSocketNetty \
    KAFKA_ZOOKEEPER_SSL_KEYSTORE_LOCATION=/etc/kafka/secrets/kafka.kafka.keystore.jks \
    KAFKA_ZOOKEEPER_SSL_KEYSTORE_PASSWORD=confluent \
    KAFKA_ZOOKEEPER_SSL_KEYSTORE_TYPE=PKCS12 \
    KAFKA_ZOOKEEPER_SSL_TRUSTSTORE_LOCATION=/etc/kafka/secrets/kafka.kafka.truststore.jks \
    KAFKA_ZOOKEEPER_SSL_TRUSTSTORE_PASSWORD=confluent \
    KAFKA_ZOOKEEPER_SSL_TRUSTSTORE_TYPE=JKS \
    KAFKA_ZOOKEEPER_SET_ACL='true' \
    KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=INTERNAL:SASL_PLAINTEXT,SSL:SSL,CLEAR:PLAINTEXT \
    KAFKA_INTER_BROKER_LISTENER_NAME=INTERNAL \
    KAFKA_ADVERTISED_LISTENERS=INTERNAL://kafka:9091,SSL://localhost:11091,CLEAR://kafka:12091 \
    KAFKA_SUPER_USERS=User:admin;User:mds;User:superUser;User:ANONYMOUS \
    KAFKA_LOG4J_LOGGERS="kafka.authorizer.logger=INFO" \
    KAFKA_LOG4J_ROOT_LOGLEVEL=INFO \
    KAFKA_BROKER_ID=1 \
    KAFKA_BROKER_RACK="r1" \
    KAFKA_JMX_PORT=9991 \
    KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL=PLAIN \
    KAFKA_SASL_ENABLED_MECHANISMS=PLAIN \
    KAFKA_LISTENER_NAME_INTERNAL_PLAIN_SASL_JAAS_CONFIG='org.apache.kafka.common.security.plain.PlainLoginModule required username=\"admin\" password=\"admin-secret\" user_admin=\"admin-secret\" user_mds=\"mds-secret\"'; \
    KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1 \
    KAFKA_CONFLUENT_LICENSE_TOPIC_REPLICATION_FACTOR=1 \
    KAFKA_CONFLUENT_SECURITY_EVENT_LOGGER_EXPORTER_KAFKA_TOPIC_REPLICAS=1 \
    KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1 \
    KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1 \
    KAFKA_CONFLUENT_BALANCER_TOPIC_REPLICATION_FACTOR=1 \
    KAFKA_CONFLUENT_BALANCER_HEAL_BROKER_FAILURE_THRESHOLD_MS=30000 \
    KAFKA_DELETE_TOPIC_ENABLE='true' \
    KAFKA_AUTO_CREATE_TOPICS_ENABLE='false' \
    KAFKA_DEFAULT_REPLICATION_FACTOR=1 \
    KAFKA_SSL_KEYSTORE_FILENAME=kafka.kafka.keystore.jks \
    KAFKA_SSL_KEYSTORE_CREDENTIALS=kafka_keystore_creds \
    KAFKA_SSL_KEY_CREDENTIALS=kafka_sslkey_creds \
    KAFKA_SSL_TRUSTSTORE_FILENAME=kafka.kafka.truststore.jks \
    KAFKA_SSL_TRUSTSTORE_CREDENTIALS=kafka_truststore_creds \
    KAFKA_SSL_CIPHER_SUITES=TLS_AES_256_GCM_SHA384,TLS_CHACHA20_POLY1305_SHA256,TLS_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 \
    KAFKA_SSL_CLIENT_AUTH="required" \
    KAFKA_LISTENER_NAME_SSL_SSL_PRINCIPAL_MAPPING_RULES="RULE:^CN=([a-zA-Z0-9.]*).*$$/$$1/ , DEFAULT" \
    KAFKA_CONFLUENT_SSL_TRUSTSTORE_LOCATION=/etc/kafka/secrets/kafka.kafka1.truststore.jks \
    KAFKA_CONFLUENT_SSL_TRUSTSTORE_PASSWORD=confluent \
    KAFKA_OPTS=-Djava.security.auth.login.config=/etc/kafka/secrets/broker_jaas.conf \
    # EmbeddedKafkaRest: Kafka Client Configuration \
    KAFKA_KAFKA_REST_BOOTSTRAP_SERVERS=SASL_SSL://kafka:10091 \
    # EmbeddedKafkaRest: Kafka Client Configuration \
    KAFKA_KAFKA_REST_BOOTSTRAP_SERVERS=SASL_SSL://kafka:10091 \
    KAFKA_KAFKA_REST_CLIENT_SECURITY_PROTOCOL=SASL_SSL \
    KAFKA_KAFKA_REST_CLIENT_SSL_TRUSTSTORE_LOCATION=/etc/kafka/secrets/kafka.kafka.truststore.jks \
    KAFKA_KAFKA_REST_CLIENT_SSL_TRUSTSTORE_PASSWORD=confluent \
    KAFKA_KAFKA_REST_CLIENT_SSL_KEYSTORE_LOCATION=/etc/kafka/secrets/kafka.kafka.keystore.jks \
    KAFKA_KAFKA_REST_CLIENT_SSL_KEYSTORE_PASSWORD=confluent \
    KAFKA_KAFKA_REST_CLIENT_SSL_KEY_PASSWORD=confluent \
    # EmbeddedKafkaRest: HTTP Auth Configuration
    KAFKA_KAFKA_REST_KAFKA_REST_RESOURCE_EXTENSION_CLASS=io.confluent.kafkarest.security.KafkaRestSecurityResourceExtension \
    KAFKA_KAFKA_REST_PUBLIC_KEY_PATH=/tmp/conf/public.pem \
    # EmbeddedKafkaRest: MDS Client configuration
    KAFKA_KAFKA_REST_SSL_TRUSTSTORE_LOCATION=/etc/kafka/secrets/kafka.kafka.truststore.jks \
    KAFKA_KAFKA_REST_SSL_TRUSTSTORE_PASSWORD=confluent 

ADD certs /etc/kafka/secrets
ADD sample_data /tmp/sample_data
